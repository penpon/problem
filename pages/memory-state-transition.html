<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript „É°„É¢„É™Áä∂ÊÖãÈÅ∑ÁßªËß£Êûê„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #f5f5f5;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .scenario-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .scenario-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .scenario-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .scenario-btn.active {
            background: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }
        
        .memory-layout {
            display: grid;
            grid-template-columns: minmax(300px, 1fr) minmax(300px, 1fr) minmax(400px, 1.2fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .memory-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 400px;
            overflow-y: auto;
            overflow-x: visible;
        }
        
        .memory-section:nth-child(3) {
            max-height: none;
            min-height: 500px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #34495e;
            color: white;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .section-info {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .memory-entry {
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            position: relative;
            transition: all 0.3s;
        }
        
        .memory-entry.highlight {
            border-color: #e74c3c;
            background: #ffe5e5;
            animation: pulse 1s;
        }
        
        .memory-entry.new {
            border-color: #27ae60;
            background: #e5ffe5;
            animation: slideIn 0.5s;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .memory-address {
            font-size: 0.85rem;
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 8px;
            font-family: monospace;
        }
        
        .memory-variable {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
        }
        
        .var-name {
            color: #2980b9;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .var-value {
            color: #27ae60;
            font-weight: bold;
            padding: 3px 8px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 4px;
        }
        
        .var-type {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-left: 10px;
        }
        
        .reference-arrow {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            color: #e67e22;
            font-size: 1.5rem;
            z-index: 20;
        }
        
        .heap-object {
            background: #fff3cd;
            border: 2px solid #f39c12;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
            word-break: break-word;
        }
        
        .heap-object.unreachable {
            opacity: 0.5;
            border-style: dashed;
            background: #ffebee;
            border-color: #e74c3c;
        }
        
        .object-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f39c12;
        }
        
        .object-type {
            color: #d35400;
            font-weight: bold;
        }
        
        .object-size {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        .object-property {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin: 3px 0;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
        }
        
        .prop-key {
            color: #8e44ad;
            font-weight: 500;
        }
        
        .prop-value {
            color: #16a085;
            font-weight: bold;
        }
        
        .code-execution {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .code-line {
            color: #ecf0f1;
            padding: 8px 15px;
            margin: 3px 0;
            border-radius: 4px;
            font-size: 0.95rem;
            transition: all 0.3s;
            position: relative;
            opacity: 0.6;
        }
        
        .code-line.executing {
            background: rgba(52, 152, 219, 0.3);
            opacity: 1;
            border-left: 4px solid #3498db;
            padding-left: 20px;
        }
        
        .code-line.executed {
            opacity: 0.8;
        }
        
        
        .comment {
            color: #95a5a6;
            font-style: italic;
            margin-left: 20px;
        }
        
        .control-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .control-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .control-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: white;
            border-radius: 8px;
        }
        
        .speed-label {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .speed-slider {
            width: 100px;
        }
        
        .memory-diagram {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .diagram-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .memory-visualization {
            display: grid;
            grid-template-columns: repeat(24, 14px);
            grid-template-rows: repeat(5, 14px);
            gap: 1px;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 8px;
            margin: 10px 0;
            width: fit-content;
            justify-content: start;
            align-content: start;
        }
        
        .memory-byte {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            font-weight: bold;
            color: white;
            border-radius: 2px;
            box-sizing: border-box;
            background: #bdc3c7;
            flex: none;
            min-width: 14px;
            min-height: 14px;
            max-width: 14px;
            max-height: 14px;
        }
        
        .memory-byte.allocated {
            background: #27ae60;
        }
        
        .memory-byte.freed {
            background: #e74c3c;
            animation: flash 0.5s;
        }
        
        /* Â§âÊï∞„Åî„Å®„ÅÆËâ≤ÂàÜ„Åë„ÇØ„É©„Çπ */
        .memory-byte.var-x { background: #3498db !important; }
        .memory-byte.var-y { background: #e74c3c !important; }
        .memory-byte.var-obj1 { background: #f39c12 !important; }
        .memory-byte.var-obj2 { background: #9b59b6 !important; }
        .memory-byte.var-arr { background: #1abc9c !important; }
        .memory-byte.var-arr2 { background: #e67e22 !important; }
        .memory-byte.var-ref { background: #8e44ad !important; }
        .memory-byte.var-closure { background: #16a085 !important; }
        .memory-byte.var-a { background: #2980b9 !important; }
        .memory-byte.var-b { background: #c0392b !important; }
        .memory-byte.var-result { background: #27ae60 !important; }
        .memory-byte.var-sum { background: #f1c40f !important; }
        
        /* „Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆËâ≤ÔºàÈùíÁ≥ªÔºâ */
        .memory-byte.stack-primitive { background: #3498db !important; }
        .memory-byte.stack-reference { background: #2980b9 !important; }
        .memory-byte.stack-function { background: #5dade2 !important; }
        
        /* „Éí„Éº„ÉóÈ†òÂüü„ÅÆËâ≤Ôºà„Ç™„É¨„É≥„Ç∏Á≥ªÔºâ */
        .memory-byte.heap-object { background: #f39c12 !important; }
        .memory-byte.heap-array { background: #e67e22 !important; }
        .memory-byte.heap-closure { background: #d35400 !important; }
        .memory-byte.heap-property { background: #f8c471 !important; }
        
        /* „É°„É¢„É™„Éû„ÉÉ„Éó„Çª„É´Áî®„ÅÆ„Çπ„Çø„Ç§„É´„É™„Çª„ÉÉ„Éà - „Éí„Éº„Éó„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇØ„É©„Çπ„ÅÆÂΩ±Èüø„ÇíÁÑ°ÂäπÂåñ */
        .memory-byte.heap-object,
        .memory-byte.heap-array,
        .memory-byte.heap-closure,
        .memory-byte.heap-property {
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 2px !important;
            word-break: normal !important;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .execution-state {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .state-box {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .state-label {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        .state-value {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .step-timeline {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .timeline-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            opacity: 0.5;
            transition: all 0.3s;
        }
        
        .timeline-step.active {
            opacity: 1;
        }
        
        .timeline-step.completed {
            opacity: 0.8;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            background: #ecf0f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: #7f8c8d;
        }
        
        .timeline-step.active .step-number {
            background: #3498db;
            color: white;
        }
        
        .timeline-step.completed .step-number {
            background: #27ae60;
            color: white;
        }
        
        .step-description {
            flex: 1;
            color: #2c3e50;
        }
        
        .pointer-visualization {
            position: relative;
            margin: 20px 0;
        }
        
        .pointer-line {
            position: absolute;
            height: 2px;
            background: #e74c3c;
            transform-origin: left center;
            z-index: 20;
        }
        
        .pointer-line::after {
            content: '‚ñ∂';
            position: absolute;
            right: -10px;
            top: -8px;
            color: #e74c3c;
            font-size: 16px;
        }
        
        .info-panel {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .info-title {
            color: #2980b9;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .info-content {
            color: #34495e;
            line-height: 1.6;
        }
        
        .gc-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 10px 15px;
            display: none;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .gc-indicator.active {
            display: block;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }
        
        @media (max-width: 992px) {
            .memory-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            .memory-section {
                max-height: none;
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>JavaScript „É°„É¢„É™Áä∂ÊÖãÈÅ∑ÁßªËß£Êûê„ÉÑ„Éº„É´</h1>
        </div>
        
        <div class="main-content">
            <div class="scenario-selector">
                <button class="scenario-btn active" onclick="loadScenario('basic', event)">Âü∫Êú¨Âûã„Å®ÂèÇÁÖßÂûã</button>
                <button class="scenario-btn" onclick="loadScenario('function', event)">Èñ¢Êï∞Âëº„Å≥Âá∫„Åó„Å®„Çπ„Ç≥„Éº„Éó</button>
                <button class="scenario-btn" onclick="loadScenario('closure', event)">„ÇØ„É≠„Éº„Ç∏„É£„Å®„É°„É¢„É™</button>
                <button class="scenario-btn" onclick="loadScenario('array', event)">ÈÖçÂàó„ÅÆÂãïÁöÑ„É°„É¢„É™</button>
                <button class="scenario-btn" onclick="loadScenario('gc', event)">„Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</button>
            </div>
            
            <div class="memory-layout">
                <!-- „Çπ„Çø„ÉÉ„ÇØÈ†òÂüü -->
                <div class="memory-section">
                    <div class="section-header">
                        <span class="section-title">„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü</span>
                        <span class="section-info">LIFOÊßãÈÄ†</span>
                    </div>
                    <div id="stack-area">
                        <!-- ÂãïÁöÑÁîüÊàê -->
                    </div>
                </div>
                
                <!-- „Éí„Éº„ÉóÈ†òÂüü -->
                <div class="memory-section">
                    <div class="section-header">
                        <span class="section-title">„Éí„Éº„ÉóÈ†òÂüü</span>
                        <span class="section-info">ÂãïÁöÑ„É°„É¢„É™</span>
                    </div>
                    <div id="heap-area">
                        <!-- ÂãïÁöÑÁîüÊàê -->
                    </div>
                </div>
                
                <!-- „É°„É¢„É™Áä∂ÊÖã -->
                <div class="memory-section">
                    <div class="section-header">
                        <span class="section-title">„É°„É¢„É™Áä∂ÊÖã</span>
                        <span class="section-info">„É™„Ç¢„É´„Çø„Ç§„É†</span>
                    </div>
                    <div class="execution-state">
                        <div class="state-box">
                            <div class="state-label">„Çπ„Çø„ÉÉ„ÇØ‰ΩøÁî®Èáè</div>
                            <div class="state-value" id="stack-usage">0 KB</div>
                        </div>
                        <div class="state-box">
                            <div class="state-label">„Éí„Éº„Éó‰ΩøÁî®Èáè</div>
                            <div class="state-value" id="heap-usage">0 KB</div>
                        </div>
                        <div class="state-box">
                            <div class="state-label">ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà</div>
                            <div class="state-value" id="ref-count">0</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 0.9rem;">„Çπ„Çø„ÉÉ„ÇØ„É°„É¢„É™„Éû„ÉÉ„Éó</div>
                        <div class="memory-visualization" id="stack-memory-map">
                            <!-- „Çπ„Çø„ÉÉ„ÇØÁî®„É°„É¢„É™„Éû„ÉÉ„Éó -->
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 0.9rem;">„Éí„Éº„Éó„É°„É¢„É™„Éû„ÉÉ„Éó</div>
                        <div class="memory-visualization" id="heap-memory-map">
                            <!-- „Éí„Éº„ÉóÁî®„É°„É¢„É™„Éû„ÉÉ„Éó -->
                        </div>
                    </div>
                    <div class="info-panel">
                        <div class="info-title">„É°„É¢„É™Ââ≤„ÇäÂΩì„Å¶ÊÉÖÂ†±</div>
                        <div class="info-content" id="memory-info">
                            ÂæÖÊ©ü‰∏≠...
                        </div>
                    </div>
                    <div class="info-panel" style="margin-top: 10px;">
                        <div class="info-title">Â§âÊï∞„ÅÆËâ≤ÂàÜ„ÅëÂá°‰æã</div>
                        <div class="info-content" id="color-legend" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- ÂãïÁöÑÁîüÊàê -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="code-execution">
                <div id="code-display">
                    <!-- ÂãïÁöÑÁîüÊàê -->
                </div>
            </div>
            
            <div class="control-panel">
                <button class="control-btn" onclick="executeStep()">Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó</button>
                <button class="control-btn" onclick="executeAll()">ÂÖ®ÂÆüË°å</button>
                <button class="control-btn" onclick="reset()">„É™„Çª„ÉÉ„Éà</button>
                <div class="speed-control">
                    <span class="speed-label">ÂÆüË°åÈÄüÂ∫¶:</span>
                    <input type="range" class="speed-slider" id="speed" min="100" max="2000" value="1000">
                    <span id="speed-value">1.0Áßí</span>
                </div>
            </div>
            
            <div class="step-timeline">
                <div class="diagram-title">ÂÆüË°å„Çø„Ç§„É†„É©„Ç§„É≥</div>
                <div id="timeline">
                    <!-- ÂãïÁöÑÁîüÊàê -->
                </div>
            </div>
            
            <canvas id="pointer-canvas"></canvas>
        </div>
    </div>
    
    <div class="gc-indicator" id="gc-indicator">
        üîÑ „Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂÆüË°å‰∏≠...
    </div>

    <script>
        // „É°„É¢„É™„Éû„Éç„Éº„Ç∏„É£„Éº
        class MemoryManager {
            constructor() {
                this.stack = [];
                this.heap = {};
                this.stackMemoryMap = new Array(120).fill(null);
                this.heapMemoryMap = new Array(120).fill(null);
                this.stackPointer = 0x7FFF;
                this.heapPointer = 0x1000;
                this.references = new Map();
                this.currentStep = 0;
                this.scenario = null;
                this.executionSpeed = 1000;
                this.isRunning = false;
                this.stackSize = 0;
                this.heapSize = 0;
                this.refCount = 0;
                this.variableColors = new Map();
                this.colorPalette = [
                    'x', 'y', 'obj1', 'obj2', 'arr', 'arr2', 'ref', 'closure', 
                    'a', 'b', 'result', 'sum'
                ];
                this.nextColorIndex = 0;
            }
            
            // Â§âÊï∞Âêç„Å´Ëâ≤„ÇØ„É©„Çπ„ÇíÂâ≤„ÇäÂΩì„Å¶
            getVariableColorClass(variableName) {
                if (!this.variableColors.has(variableName)) {
                    // Êñ∞„Åó„ÅÑÂ§âÊï∞„ÅÆÂ†¥Âêà„ÄÅËâ≤„ÇØ„É©„ÇπÂêç„ÇíÊ±∫ÂÆö
                    let colorClass;
                    if (this.colorPalette.includes(variableName)) {
                        colorClass = `var-${variableName}`;
                    } else {
                        // ‰∫àÂÆöËâ≤„Å´„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Éô„Éº„Çπ„ÅÆËâ≤„Çí‰ΩøÁî®
                        const index = this.nextColorIndex % this.colorPalette.length;
                        colorClass = `var-${this.colorPalette[index]}`;
                        this.nextColorIndex++;
                    }
                    this.variableColors.set(variableName, colorClass);
                }
                return this.variableColors.get(variableName);
            }
            
            // „Çπ„Çø„ÉÉ„ÇØ„Å´„Éó„ÉÉ„Ç∑„É•
            pushStack(name, value, type = 'primitive') {
                const address = `0x${this.stackPointer.toString(16).toUpperCase()}`;
                this.stackPointer -= 4;
                
                const entry = {
                    address,
                    name,
                    value,
                    type,
                    size: 8  // „Éó„É™„Éü„ÉÜ„Ç£„ÉñÂûã„ÄÅÂèÇÁÖßÂûã„Å®„ÇÇ„Å´8„Éê„Ç§„Éà
                };
                
                this.stack.push(entry);
                this.stackSize += entry.size;
                
                if (type === 'reference') {
                    this.refCount++;
                }
                
                this.renderStack();
                this.updateMemoryStats();
                this.allocateStackMemoryMap(entry.size, name);
                
                return address;
            }
            
            // „Çπ„Çø„ÉÉ„ÇØ„Åã„Çâ„Éù„ÉÉ„Éó
            popStack() {
                if (this.stack.length > 0) {
                    const entry = this.stack.pop();
                    this.stackPointer += 4;
                    this.stackSize -= entry.size;
                    
                    if (entry.type === 'reference') {
                        this.refCount--;
                        this.checkUnreachableObjects();
                    }
                    
                    this.renderStack();
                    this.updateMemoryStats();
                    this.freeStackMemoryMap(entry.size, entry.name);
                    
                    return entry;
                }
                return null;
            }
            
            // „Éí„Éº„Éó„Å´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
            createHeapObject(type, data, variableName) {
                const address = `0x${this.heapPointer.toString(16).toUpperCase()}`;
                const size = this.calculateObjectSize(data);
                this.heapPointer += size;
                
                const heapEntry = {
                    address,
                    type,
                    data: JSON.parse(JSON.stringify(data)), // „Éá„Ç£„Éº„Éó„Ç≥„Éî„Éº„ÅßÂèÇÁÖß„ÅÆÂïèÈ°å„ÇíÂõûÈÅø
                    size,
                    referenceCount: 0,
                    reachable: true,
                    variableName: variableName
                };
                
                this.heap[address] = heapEntry;
                this.heapSize += size;
                
                this.renderHeap();
                this.updateMemoryStats();
                this.allocateHeapMemoryMap(size, variableName, data);
                
                return address;
            }
            
            // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çµ„Ç§„Ç∫Ë®àÁÆó
            calculateObjectSize(data) {
                if (Array.isArray(data)) {
                    return 32 + data.length * 8;
                } else if (typeof data === 'object') {
                    return 32 + Object.keys(data).length * 16;
                }
                return 32;
            }
            
            // „Çπ„Çø„ÉÉ„ÇØË°®Á§∫
            renderStack() {
                const stackArea = document.getElementById('stack-area');
                stackArea.innerHTML = '';
                
                // „Çπ„Çø„ÉÉ„ÇØ„ÇíÈÄÜÈ†Ü„ÅßË°®Á§∫ÔºàTOP„Åå‰∏äÔºâ
                this.stack.slice().reverse().forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'memory-entry';
                    if (index === 0) div.classList.add('new');
                    
                    div.innerHTML = `
                        <div class="memory-address">${entry.address}</div>
                        <div class="memory-variable">
                            <span class="var-name">${entry.name}</span>
                            <span>
                                <span class="var-value">${entry.type === 'reference' ? '‚Üí ' + entry.value : entry.value}</span>
                                <span class="var-type">[${entry.type}]</span>
                            </span>
                        </div>
                        ${entry.type === 'reference' ? '<span class="reference-arrow">‚Üí</span>' : ''}
                    `;
                    
                    stackArea.appendChild(div);
                });
            }
            
            // „Éí„Éº„ÉóË°®Á§∫
            renderHeap() {
                const heapArea = document.getElementById('heap-area');
                heapArea.innerHTML = '';
                
                Object.values(this.heap).forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'heap-object';
                    if (!entry.reachable) {
                        div.classList.add('unreachable');
                    }
                    
                    let propertiesHtml = '';
                    if (Array.isArray(entry.data)) {
                        propertiesHtml = entry.data.map((val, i) => `
                            <div class="object-property">
                                <span class="prop-key">[${i}]</span>
                                <span class="prop-value">${val}</span>
                            </div>
                        `).join('');
                    } else if (typeof entry.data === 'object') {
                        propertiesHtml = Object.entries(entry.data).map(([key, val]) => `
                            <div class="object-property">
                                <span class="prop-key">${key}:</span>
                                <span class="prop-value">${val}</span>
                            </div>
                        `).join('');
                    }
                    
                    div.innerHTML = `
                        <div class="memory-address">${entry.address}</div>
                        <div class="object-header">
                            <span class="object-type">${entry.type}</span>
                            <span class="object-size">${entry.size} bytes</span>
                        </div>
                        ${propertiesHtml}
                    `;
                    
                    heapArea.appendChild(div);
                });
            }
            
            // „Çπ„Çø„ÉÉ„ÇØÁî®„É°„É¢„É™„Éû„ÉÉ„ÉóÊõ¥Êñ∞
            allocateStackMemoryMap(size, variableName) {
                let bytes = Math.ceil(size / 8);
                
                // „Çπ„Çø„ÉÉ„ÇØ„Åã„ÇâÂ§âÊï∞„ÅÆÂÄ§„ÇíÂèñÂæó
                const stackEntry = this.stack.find(e => e.name === variableName);
                if (!stackEntry) return;
                
                // Ëâ≤„ÇØ„É©„Çπ„ÅÆÊ±∫ÂÆöÔºàÂ§âÊï∞Âêç„Éô„Éº„Çπ„ÅÆËâ≤ÂàÜ„ÅëÔºâ
                let colorClass = this.getVariableColorClass(variableName);
                
                let value = 0;
                if (stackEntry.type === 'reference') {
                    // ÂèÇÁÖßÂûã„ÅÆÂ†¥Âêà„ÄÅ„Ç¢„Éâ„É¨„ÇπÂÄ§„ÇíÊï∞ÂÄ§„Å´Â§âÊèõ
                    const addressMatch = stackEntry.value.match(/0x([0-9A-F]+)/i);
                    if (addressMatch) {
                        value = parseInt(addressMatch[1], 16);
                    }
                } else {
                    value = typeof stackEntry.value === 'number' ? stackEntry.value : 0;
                }
                
                let cellIndex = 0;
                for (let i = 0; i < this.stackMemoryMap.length && bytes > 0; i++) {
                    if (this.stackMemoryMap[i] === null) {
                        this.stackMemoryMap[i] = variableName;
                        bytes--;
                        const cell = document.querySelector(`#stack-memory-map .memory-byte:nth-child(${i + 1})`);
                        if (cell) {
                            cell.classList.add('allocated');
                            cell.classList.add(colorClass);
                            cell.setAttribute('data-variable', variableName);
                            
                            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
                            let tooltipText;
                            if (stackEntry.type === 'reference') {
                                const referencedObject = Object.values(this.heap).find(obj => obj.address === stackEntry.value);
                                const objName = referencedObject ? referencedObject.variableName : 'unknown';
                                tooltipText = `„Çπ„Çø„ÉÉ„ÇØÂ§âÊï∞: ${variableName} ‚Üí ${objName}„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà (${stackEntry.value})`;
                            } else {
                                tooltipText = `„Çπ„Çø„ÉÉ„ÇØÂ§âÊï∞: ${variableName} = ${stackEntry.value} („Éó„É™„Éü„ÉÜ„Ç£„ÉñÂûã)`;
                            }
                            cell.title = tooltipText;
                            
                            // 16ÈÄ≤Êï∞ÂÄ§„ÅÆË°®Á§∫
                            let hexValue;
                            if (stackEntry.type === 'reference') {
                                const byteShift = cellIndex * 8;
                                hexValue = ((value >> byteShift) & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                            } else {
                                hexValue = (value & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                            }
                            cell.textContent = hexValue;
                            cellIndex++;
                        }
                    }
                }
            }
            
            // „Éí„Éº„ÉóÁî®„É°„É¢„É™„Éû„ÉÉ„ÉóÊõ¥Êñ∞
            allocateHeapMemoryMap(size, variableName, data) {
                let bytes = Math.ceil(size / 8);
                
                // Ëâ≤„ÇØ„É©„Çπ„ÅÆÊ±∫ÂÆöÔºàÂ§âÊï∞Âêç„Éô„Éº„Çπ„ÅÆËâ≤ÂàÜ„ÅëÔºâ
                let colorClass = this.getVariableColorClass(variableName);
                
                let cellIndex = 0;
                for (let i = 0; i < this.heapMemoryMap.length && bytes > 0; i++) {
                    if (this.heapMemoryMap[i] === null) {
                        this.heapMemoryMap[i] = variableName;
                        bytes--;
                        const cell = document.querySelector(`#heap-memory-map .memory-byte:nth-child(${i + 1})`);
                        if (cell) {
                            cell.classList.add('allocated');
                            cell.classList.add(colorClass);
                            cell.setAttribute('data-variable', variableName);
                            
                            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
                            let tooltipText = `„Éí„Éº„Éó„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà: ${variableName} (${size}„Éê„Ç§„Éà)`;
                            cell.title = tooltipText;
                            
                            // ÂÆüÈöõ„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£ÂÄ§„ÇíË°®Á§∫
                            let displayValue;
                            if (Array.isArray(data) && cellIndex < data.length) {
                                displayValue = (data[cellIndex] & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                            } else if (typeof data === 'object' && !Array.isArray(data) && !data.name) {
                                const values = Object.values(data);
                                if (cellIndex < values.length && typeof values[cellIndex] === 'number') {
                                    displayValue = (values[cellIndex] & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                                } else {
                                    displayValue = (size & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                                }
                            } else {
                                displayValue = (size & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                            }
                            
                            cell.textContent = displayValue;
                            cellIndex++;
                        }
                    }
                }
            }
            
            // „Çπ„Çø„ÉÉ„ÇØÁî®„É°„É¢„É™„Éû„ÉÉ„ÉóËß£Êîæ
            freeStackMemoryMap(size, variableName) {
                const bytes = Math.ceil(size / 8);
                let freed = 0;
                for (let i = this.stackMemoryMap.length - 1; i >= 0 && freed < bytes; i--) {
                    if (this.stackMemoryMap[i] === variableName) {
                        this.stackMemoryMap[i] = null;
                        freed++;
                        const cell = document.querySelector(`#stack-memory-map .memory-byte:nth-child(${i + 1})`);
                        if (cell) {
                            cell.classList.remove('allocated', 'stack-primitive', 'stack-reference');
                            cell.classList.add('freed');
                            cell.removeAttribute('data-variable');
                            cell.removeAttribute('title');
                            cell.textContent = '00';
                            setTimeout(() => cell.classList.remove('freed'), 500);
                        }
                    }
                }
            }
            
            // „Éí„Éº„ÉóÁî®„É°„É¢„É™„Éû„ÉÉ„ÉóËß£Êîæ
            freeHeapMemoryMap(size, variableName) {
                const bytes = Math.ceil(size / 8);
                let freed = 0;
                for (let i = this.heapMemoryMap.length - 1; i >= 0 && freed < bytes; i--) {
                    if (this.heapMemoryMap[i] === variableName) {
                        this.heapMemoryMap[i] = null;
                        freed++;
                        const cell = document.querySelector(`#heap-memory-map .memory-byte:nth-child(${i + 1})`);
                        if (cell) {
                            cell.classList.remove('allocated', 'heap-object', 'heap-array', 'heap-closure');
                            cell.classList.add('freed');
                            cell.removeAttribute('data-variable');
                            cell.removeAttribute('title');
                            cell.textContent = '00';
                            setTimeout(() => cell.classList.remove('freed'), 500);
                        }
                    }
                }
            }
            
            // „Éí„Éº„Éó„É°„É¢„É™„Éû„ÉÉ„Éó„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
            updateHeapMemoryMapValue(variableName, data) {
                let cellIndex = 0;
                for (let i = 0; i < this.heapMemoryMap.length; i++) {
                    if (this.heapMemoryMap[i] === variableName) {
                        const cell = document.querySelector(`#heap-memory-map .memory-byte:nth-child(${i + 1})`);
                        if (cell) {
                            // ÂÆüÈöõ„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£ÂÄ§„ÇíË°®Á§∫
                            let displayValue;
                            if (Array.isArray(data) && cellIndex < data.length) {
                                displayValue = (data[cellIndex] & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                            } else if (typeof data === 'object' && !Array.isArray(data) && !data.name) {
                                const values = Object.values(data);
                                if (cellIndex < values.length && typeof values[cellIndex] === 'number') {
                                    displayValue = (values[cellIndex] & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                                } else {
                                    // „Åù„ÅÆ‰ªñ„ÅÆ„Çª„É´„ÅØÁèæÂú®„ÅÆÂÄ§„Çí‰øùÊåÅ
                                    displayValue = cell.textContent;
                                }
                            } else {
                                displayValue = cell.textContent;
                            }
                            
                            cell.textContent = displayValue;
                            
                            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇÇÊõ¥Êñ∞
                            if (typeof data === 'object' && !Array.isArray(data) && !data.name) {
                                const props = Object.entries(data).map(([k, v]) => `${k}: ${v}`).join(', ');
                                cell.title = `„Éí„Éº„Éó„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà: ${variableName} {${props}}`;
                            }
                            cellIndex++;
                        }
                    }
                }
            }
            
            // „Çπ„Çø„ÉÉ„ÇØÁî®„É°„É¢„É™„Éû„ÉÉ„Éó„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
            updateStackMemoryMapValue(variableName, newValue) {
                const stackEntry = this.stack.find(e => e.name === variableName);
                if (!stackEntry) return;
                
                let cellIndex = 0;
                for (let i = 0; i < this.stackMemoryMap.length; i++) {
                    if (this.stackMemoryMap[i] === variableName) {
                        const cell = document.querySelector(`#stack-memory-map .memory-byte:nth-child(${i + 1})`);
                        if (cell) {
                            let value = 0;
                            let colorClass = this.getVariableColorClass(variableName);
                            
                            if (stackEntry.type === 'reference') {
                                const addressMatch = newValue.match(/0x([0-9A-F]+)/i);
                                if (addressMatch) {
                                    value = parseInt(addressMatch[1], 16);
                                }
                            } else {
                                value = typeof newValue === 'number' ? newValue : 0;
                            }
                            
                            cell.className = 'memory-byte allocated ' + colorClass;
                            
                            let hexValue;
                            if (stackEntry.type === 'reference') {
                                const byteShift = cellIndex * 8;
                                hexValue = ((value >> byteShift) & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                            } else {
                                hexValue = (value & 0xFF).toString(16).toUpperCase().padStart(2, '0');
                            }
                            cell.textContent = hexValue;
                            
                            let tooltipText;
                            if (stackEntry.type === 'reference') {
                                const referencedObject = Object.values(this.heap).find(obj => obj.address === newValue);
                                const objName = referencedObject ? referencedObject.variableName : 'unknown';
                                tooltipText = `„Çπ„Çø„ÉÉ„ÇØÂ§âÊï∞: ${variableName} ‚Üí ${objName}„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà (${newValue})`;
                            } else {
                                tooltipText = `„Çπ„Çø„ÉÉ„ÇØÂ§âÊï∞: ${variableName} = ${newValue} („Éó„É™„Éü„ÉÜ„Ç£„ÉñÂûã)`;
                            }
                            cell.title = tooltipText;
                            cellIndex++;
                        }
                    }
                }
            }
            
            // „É°„É¢„É™Áµ±Ë®àÊõ¥Êñ∞
            updateMemoryStats() {
                // „Çπ„Çø„ÉÉ„ÇØ„Çµ„Ç§„Ç∫„ÇíÂÆüÈöõ„ÅÆ„Çπ„Çø„ÉÉ„ÇØ„Ç®„É≥„Éà„É™„Åã„ÇâË®àÁÆó
                const actualStackSize = this.stack.reduce((total, entry) => total + entry.size, 0);
                
                // „Éí„Éº„Éó„Çµ„Ç§„Ç∫„ÇíÂÆüÈöõ„ÅÆ„Éí„Éº„Éó„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâË®àÁÆóÔºàÂà∞ÈÅîÂèØËÉΩ„Å™„ÇÇ„ÅÆ„ÅÆ„ÅøÔºâ
                const actualHeapSize = Object.values(this.heap)
                    .filter(obj => obj.reachable)
                    .reduce((total, obj) => total + obj.size, 0);
                
                // ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà„ÇíÂÆüÈöõ„ÅÆ„Çπ„Çø„ÉÉ„ÇØ„Ç®„É≥„Éà„É™„Åã„ÇâË®àÁÆó
                const actualRefCount = this.stack.filter(entry => entry.type === 'reference').length;
                
                document.getElementById('stack-usage').textContent = `${(actualStackSize / 1024).toFixed(3)} KB`;
                document.getElementById('heap-usage').textContent = `${(actualHeapSize / 1024).toFixed(3)} KB`;
                document.getElementById('ref-count').textContent = actualRefCount;
                
                // ÂÜÖÈÉ®Áä∂ÊÖã„ÇÇÊõ¥Êñ∞
                this.stackSize = actualStackSize;
                this.heapSize = actualHeapSize;
                this.refCount = actualRefCount;
                
                const totalUsage = this.stackSize + this.heapSize;
                const info = `
                    „Çπ„Çø„ÉÉ„ÇØ: ${this.stack.length} ÂÄã„ÅÆÂ§âÊï∞<br>
                    „Éí„Éº„Éó: ${Object.keys(this.heap).length} ÂÄã„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà<br>
                    Á∑è„É°„É¢„É™‰ΩøÁî®Èáè: ${(totalUsage / 1024).toFixed(3)} KB<br>
                    Á©∫„Åç„É°„É¢„É™: ${((256 * 32 - totalUsage) / 1024).toFixed(3)} KB
                `;
                document.getElementById('memory-info').innerHTML = info;
                this.updateColorLegend();
            }
            
            // Ëâ≤ÂàÜ„ÅëÂá°‰æã„ÇíÊõ¥Êñ∞
            updateColorLegend() {
                const legendContainer = document.getElementById('color-legend');
                if (!legendContainer) return;
                
                legendContainer.innerHTML = '';
                
                // ÁèæÂú®‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„ÇãÂ§âÊï∞Âêç„Å®Ëâ≤„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂèñÂæó
                const usedVariables = new Set();
                
                // „Çπ„Çø„ÉÉ„ÇØ„Åã„ÇâÂ§âÊï∞Âêç„ÇíÂèéÈõÜ
                this.stack.forEach(entry => {
                    usedVariables.add(entry.name);
                });
                
                // „Éí„Éº„Éó„Åã„ÇâÂ§âÊï∞Âêç„ÇíÂèéÈõÜ
                Object.values(this.heap).forEach(entry => {
                    if (entry.variableName) {
                        usedVariables.add(entry.variableName);
                    }
                });
                
                // ‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„ÇãÂ§âÊï∞„ÅÆÂá°‰æã„Çí‰ΩúÊàê
                usedVariables.forEach(varName => {
                    const colorClass = this.getVariableColorClass(varName);
                    const legendItem = document.createElement('div');
                    legendItem.style.display = 'flex';
                    legendItem.style.alignItems = 'center';
                    legendItem.style.gap = '4px';
                    legendItem.style.fontSize = '0.85rem';
                    
                    const colorBox = document.createElement('div');
                    colorBox.style.width = '12px';
                    colorBox.style.height = '12px';
                    colorBox.style.borderRadius = '2px';
                    colorBox.className = `memory-byte ${colorClass}`;
                    
                    const label = document.createElement('span');
                    label.textContent = varName;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(label);
                    legendContainer.appendChild(legendItem);
                });
            }
            
            // Âà∞ÈÅî‰∏çÂèØËÉΩ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
            checkUnreachableObjects() {
                // „Åô„Åπ„Å¶„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂà∞ÈÅî‰∏çÂèØËÉΩ„Å®„Åó„Å¶„Éû„Éº„ÇØ
                Object.values(this.heap).forEach(obj => {
                    obj.reachable = false;
                });
                
                // „Çπ„Çø„ÉÉ„ÇØ„Åã„ÇâÂèÇÁÖß„Åï„Çå„Å¶„ÅÑ„Çã„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí„Éû„Éº„ÇØ
                this.stack.forEach(entry => {
                    if (entry.type === 'reference' && this.heap[entry.value]) {
                        this.heap[entry.value].reachable = true;
                    }
                });
                
                this.renderHeap();
            }
            
            // „Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
            runGarbageCollection() {
                const indicator = document.getElementById('gc-indicator');
                indicator.classList.add('active');
                
                setTimeout(() => {
                    const unreachable = Object.values(this.heap).filter(obj => !obj.reachable);
                    unreachable.forEach(obj => {
                        this.heapSize -= obj.size;
                        this.freeHeapMemoryMap(obj.size, obj.variableName);
                        delete this.heap[obj.address];
                    });
                    
                    this.renderHeap();
                    this.updateMemoryStats();
                    indicator.classList.remove('active');
                }, 1500);
            }
        }
        
        // „Ç∑„Éä„É™„Ç™ÂÆöÁæ©
        const scenarios = {
            basic: {
                title: "Âü∫Êú¨Âûã„Å®ÂèÇÁÖßÂûã„ÅÆÂãï‰Ωú",
                code: [
                    "// „Éó„É™„Éü„ÉÜ„Ç£„ÉñÂûã„ÅÆÂÄ§Ê∏°„Åó",
                    "let x = 42;",
                    "let y = x;  // ÂÄ§„Åå„Ç≥„Éî„Éº„Åï„Çå„Çã",
                    "y = 100;    // x„ÅØÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ",
                    "",
                    "let obj1 = { value: 10 };",
                    "let obj2 = obj1;  // ÂèÇÁÖß„Åå„Ç≥„Éî„Éº„Åï„Çå„Çã",
                    "obj2.value = 20;  // obj1„ÇÇÂ§âÊõ¥„Åï„Çå„Çã"
                ],
                steps: [
                    { type: 'push', name: 'x', value: 42, dataType: 'primitive' },
                    { type: 'push', name: 'y', value: 42, dataType: 'primitive' },
                    { type: 'modify', name: 'y', value: 100 },
                    { type: 'createObject', varName: 'obj1', data: { value: 10 } },
                    { type: 'copyReference', from: 'obj1', to: 'obj2' },
                    { type: 'modifyObject', ref: 'obj2', key: 'value', value: 20 }
                ]
            },
            function: {
                title: "Èñ¢Êï∞Âëº„Å≥Âá∫„Åó„Å®„Çπ„Ç≥„Éº„Éó",
                code: [
                    "function add(a, b) {",
                    "    let result = a + b;",
                    "    return result;",
                    "}",
                    "",
                    "let x = 10;",
                    "let y = 20;",
                    "let sum = add(x, y);"
                ],
                steps: [
                    { type: 'push', name: 'x', value: 10, dataType: 'primitive' },
                    { type: 'push', name: 'y', value: 20, dataType: 'primitive' },
                    { type: 'functionCall', name: 'add' },
                    { type: 'push', name: 'a', value: 10, dataType: 'primitive' },
                    { type: 'push', name: 'b', value: 20, dataType: 'primitive' },
                    { type: 'push', name: 'result', value: 30, dataType: 'primitive' },
                    { type: 'functionReturn', value: 30 },
                    { type: 'push', name: 'sum', value: 30, dataType: 'primitive' }
                ]
            },
            closure: {
                title: "„ÇØ„É≠„Éº„Ç∏„É£„Å®„É°„É¢„É™‰øùÊåÅ",
                code: [
                    "function outer(x) {",
                    "    return function inner(y) {",
                    "        return x + y;",
                    "    };",
                    "}",
                    "",
                    "let closure = outer(10);",
                    "let result = closure(5);"
                ],
                steps: [
                    { type: 'functionCall', name: 'outer' },
                    { type: 'push', name: 'x', value: 10, dataType: 'primitive' },
                    { type: 'createClosure', name: 'inner', capturedVars: ['x'] },
                    { type: 'push', name: 'closure', value: '0x2000', dataType: 'reference' },
                    { type: 'functionCall', name: 'closure' },
                    { type: 'push', name: 'y', value: 5, dataType: 'primitive' },
                    { type: 'push', name: 'result', value: 15, dataType: 'primitive' }
                ]
            },
            array: {
                title: "ÈÖçÂàó„ÅÆÂãïÁöÑ„É°„É¢„É™Ââ≤„ÇäÂΩì„Å¶",
                code: [
                    "let arr = [1, 2, 3];",
                    "arr.push(4);  // ÈÖçÂàó„ÇíÊã°Âºµ",
                    "arr[0] = 10;  // Ë¶ÅÁ¥†„ÇíÂ§âÊõ¥",
                    "",
                    "let arr2 = arr;  // ÂèÇÁÖß„ÅÆ„Ç≥„Éî„Éº",
                    "arr2.push(5);    // ‰∏°Êñπ„Å´ÂΩ±Èüø"
                ],
                steps: [
                    { type: 'createObject', varName: 'arr', data: [1, 2, 3], objType: 'Array' },
                    { type: 'arrayPush', ref: 'arr', value: 4 },
                    { type: 'arrayModify', ref: 'arr', index: 0, value: 10 },
                    { type: 'copyReference', from: 'arr', to: 'arr2' },
                    { type: 'arrayPush', ref: 'arr2', value: 5 }
                ]
            },
            gc: {
                title: "„Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥",
                code: [
                    "let obj = { data: 'important' };",
                    "let ref = obj;  // ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà: 2",
                    "",
                    "obj = null;     // ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà: 1",
                    "ref = null;     // ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà: 0",
                    "// „Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂØæË±°"
                ],
                steps: [
                    { type: 'createObject', varName: 'obj', data: { data: 'important' } },
                    { type: 'copyReference', from: 'obj', to: 'ref' },
                    { type: 'nullify', name: 'obj' },
                    { type: 'nullify', name: 'ref' },
                    { type: 'gc' }
                ]
            }
        };
        
        // „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ
        const memoryManager = new MemoryManager();
        
        // „Ç∑„Éä„É™„Ç™Ë™≠„ÅøËæº„Åø
        function loadScenario(scenarioName, event) {
            // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // event„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØevent.target„Çí„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç∑„Éä„É™„Ç™Âêç„Åß„Éú„Çø„É≥„ÇíÊé¢„Åô
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // „Ç∑„Éä„É™„Ç™Âêç„Å´Âü∫„Å•„ÅÑ„Å¶„Éú„Çø„É≥„ÇíÊé¢„Åô
                const scenarioMapping = {
                    'basic': 'Âü∫Êú¨Âûã„Å®ÂèÇÁÖßÂûã',
                    'function': 'Èñ¢Êï∞Âëº„Å≥Âá∫„Åó„Å®„Çπ„Ç≥„Éº„Éó',
                    'closure': '„ÇØ„É≠„Éº„Ç∏„É£„Å®„É°„É¢„É™',
                    'array': 'ÈÖçÂàó„ÅÆÂãïÁöÑ„É°„É¢„É™',
                    'gc': '„Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥'
                };
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    if (btn.textContent.trim() === scenarioMapping[scenarioName]) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // „Ç∑„Éä„É™„Ç™Ë®≠ÂÆö
            const scenario = scenarios[scenarioName];
            memoryManager.scenario = scenario;
            memoryManager.currentStep = 0;
            
            // „Ç≥„Éº„ÉâË°®Á§∫
            const codeDisplay = document.getElementById('code-display');
            codeDisplay.innerHTML = scenario.code.map((line, index) => `
                <div class="code-line" id="code-line-${index}">
                    ${line}
                </div>
            `).join('');
            
            // „Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = scenario.steps.map((step, index) => `
                <div class="timeline-step" id="step-${index}">
                    <div class="step-number">${index + 1}</div>
                    <div class="step-description">${getStepDescription(step)}</div>
                </div>
            `).join('');
            
            reset();
        }
        
        // „Çπ„ÉÜ„ÉÉ„ÉóË™¨ÊòéÂèñÂæó
        function getStepDescription(step) {
            switch(step.type) {
                case 'push':
                    return `„Çπ„Çø„ÉÉ„ÇØ„Å´ ${step.name} = ${step.value} „ÇíËøΩÂä†`;
                case 'modify':
                    return `${step.name} „Çí ${step.value} „Å´Â§âÊõ¥`;
                case 'createObject':
                    return `„Éí„Éº„Éó„Å´ ${step.varName} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê`;
                case 'copyReference':
                    return `${step.from} „ÅÆÂèÇÁÖß„Çí ${step.to} „Å´„Ç≥„Éî„Éº`;
                case 'modifyObject':
                    return `${step.ref}.${step.key} „Çí ${step.value} „Å´Â§âÊõ¥`;
                case 'functionCall':
                    return `Èñ¢Êï∞ ${step.name} „ÇíÂëº„Å≥Âá∫„Åó`;
                case 'functionReturn':
                    return `Èñ¢Êï∞„Åã„Çâ ${step.value} „ÇíËøîÂç¥`;
                case 'arrayPush':
                    return `${step.ref} „Å´ ${step.value} „ÇíËøΩÂä†`;
                case 'arrayModify':
                    return `${step.ref}[${step.index}] „Çí ${step.value} „Å´Â§âÊõ¥`;
                case 'nullify':
                    return `${step.name} „Çí null „Å´Ë®≠ÂÆö`;
                case 'gc':
                    return '„Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂÆüË°å';
                case 'createClosure':
                    return `„ÇØ„É≠„Éº„Ç∏„É£ ${step.name} „Çí‰ΩúÊàê`;
                default:
                    return step.type;
            }
        }
        
        // „Çπ„ÉÜ„ÉÉ„ÉóÂÆüË°å
        function executeStep() {
            if (!memoryManager.scenario || memoryManager.currentStep >= memoryManager.scenario.steps.length) {
                return;
            }
            
            const step = memoryManager.scenario.steps[memoryManager.currentStep];
            
            // „Çø„Ç§„É†„É©„Ç§„É≥Êõ¥Êñ∞
            document.querySelectorAll('.timeline-step').forEach((el, index) => {
                el.classList.remove('active');
                if (index < memoryManager.currentStep) {
                    el.classList.add('completed');
                } else if (index === memoryManager.currentStep) {
                    el.classList.add('active');
                }
            });
            
            // „Ç≥„Éº„ÉâË°å„Éè„Ç§„É©„Ç§„Éà
            const codeLineIndex = getCodeLineForStep(memoryManager.currentStep);
            document.querySelectorAll('.code-line').forEach((el, index) => {
                el.classList.remove('executing');
                if (index < codeLineIndex) {
                    el.classList.add('executed');
                } else if (index === codeLineIndex) {
                    el.classList.add('executing');
                }
            });
            
            // „Çπ„ÉÜ„ÉÉ„ÉóÂÆüË°å
            executeStepAction(step);
            
            memoryManager.currentStep++;
        }
        
        // „Çπ„ÉÜ„ÉÉ„Éó„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
        function executeStepAction(step) {
            switch(step.type) {
                case 'push':
                    memoryManager.pushStack(step.name, step.value, step.dataType);
                    break;
                    
                case 'modify':
                    const stackEntry = memoryManager.stack.find(e => e.name === step.name);
                    if (stackEntry) {
                        stackEntry.value = step.value;
                        memoryManager.renderStack();
                        highlightEntry(stackEntry);
                        // „É°„É¢„É™„Éû„ÉÉ„Éó„ÅÆË©≤ÂΩì„Çª„É´„ÇÇÊõ¥Êñ∞
                        memoryManager.updateStackMemoryMapValue(step.name, step.value);
                    }
                    break;
                    
                case 'createObject':
                    const heapAddr = memoryManager.createHeapObject(step.objType || 'Object', step.data, step.varName);
                    memoryManager.pushStack(step.varName, heapAddr, 'reference');
                    break;
                    
                case 'copyReference':
                    const sourceRef = memoryManager.stack.find(e => e.name === step.from);
                    if (sourceRef) {
                        memoryManager.pushStack(step.to, sourceRef.value, 'reference');
                    }
                    break;
                    
                case 'modifyObject':
                    const ref = memoryManager.stack.find(e => e.name === step.ref);
                    if (ref && memoryManager.heap[ref.value]) {
                        memoryManager.heap[ref.value].data[step.key] = step.value;
                        memoryManager.renderHeap();
                        // „É°„É¢„É™„Éû„ÉÉ„Éó„ÇÇÊõ¥Êñ∞ - ÂÆüÈöõ„ÅÆ„Éí„Éº„Éó„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ§âÊï∞Âêç„Çí‰ΩøÁî®
                        memoryManager.updateHeapMemoryMapValue(memoryManager.heap[ref.value].variableName, memoryManager.heap[ref.value].data);
                    }
                    break;
                    
                case 'arrayPush':
                    const arrRef = memoryManager.stack.find(e => e.name === step.ref);
                    if (arrRef && memoryManager.heap[arrRef.value]) {
                        memoryManager.heap[arrRef.value].data.push(step.value);
                        memoryManager.renderHeap();
                        // „É°„É¢„É™„Éû„ÉÉ„Éó„ÇÇÊõ¥Êñ∞
                        memoryManager.updateHeapMemoryMapValue(step.ref, memoryManager.heap[arrRef.value].data);
                    }
                    break;
                    
                case 'arrayModify':
                    const arrRef2 = memoryManager.stack.find(e => e.name === step.ref);
                    if (arrRef2 && memoryManager.heap[arrRef2.value]) {
                        memoryManager.heap[arrRef2.value].data[step.index] = step.value;
                        memoryManager.renderHeap();
                        // „É°„É¢„É™„Éû„ÉÉ„Éó„ÇÇÊõ¥Êñ∞
                        memoryManager.updateHeapMemoryMapValue(step.ref, memoryManager.heap[arrRef2.value].data);
                    }
                    break;
                    
                case 'nullify':
                    const entry = memoryManager.stack.find(e => e.name === step.name);
                    if (entry) {
                        entry.value = 'null';
                        entry.type = 'primitive';
                        memoryManager.refCount--;
                        memoryManager.checkUnreachableObjects();
                        memoryManager.renderStack();
                        memoryManager.updateMemoryStats();
                    }
                    break;
                    
                case 'gc':
                    memoryManager.runGarbageCollection();
                    break;
                    
                case 'functionCall':
                    // „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆË¶ñË¶öÁöÑË°®Áèæ
                    const frameMarker = document.createElement('div');
                    frameMarker.style.borderTop = '2px solid #e74c3c';
                    frameMarker.style.margin = '10px 0';
                    document.getElementById('stack-area').appendChild(frameMarker);
                    break;
                    
                case 'functionReturn':
                    // Èñ¢Êï∞„Çπ„Ç≥„Éº„Éó„ÅÆÂ§âÊï∞„ÇíÂâäÈô§ - „Çà„ÇäÂÆâÂÖ®„Å™ÂÆüË£Ö
                    const frameMarkers = document.querySelectorAll('#stack-area > div[style*="border-top"]');
                    if (frameMarkers.length > 0) {
                        // ÊúÄÂæå„ÅÆ„Éï„É¨„Éº„É†„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
                        frameMarkers[frameMarkers.length - 1].remove();
                    }
                    break;
                    
                case 'createClosure':
                    const closureAddr = memoryManager.createHeapObject('Closure', {
                        name: step.name,
                        capturedVars: step.capturedVars,
                        scope: step.capturedVars.reduce((acc, varName) => {
                            const stackVar = memoryManager.stack.find(e => e.name === varName);
                            if (stackVar) {
                                acc[varName] = stackVar.value;
                            }
                            return acc;
                        }, {})
                    }, step.name);
                    // „ÇØ„É≠„Éº„Ç∏„É£„ÅÆÂèÇÁÖß„ÅØÈÄöÂ∏∏„ÅØÂæåÁ∂ö„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅßÂ§âÊï∞„Å´Ââ≤„ÇäÂΩì„Å¶„Çâ„Çå„Çã
                    break;
            }
        }
        
        // „Ç≥„Éº„ÉâË°å„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂèñÂæó
        function getCodeLineForStep(stepIndex) {
            const scenario = memoryManager.scenario;
            if (!scenario) return 0;
            
            // ÂêÑ„Ç∑„Éä„É™„Ç™„Å´ÂØæÂøú„Åó„ÅüË©≥Á¥∞„Å™„Éû„ÉÉ„Éî„É≥„Ç∞
            const scenarioMappings = {
                "Âü∫Êú¨Âûã„Å®ÂèÇÁÖßÂûã„ÅÆÂãï‰Ωú": [
                    1, // „Çπ„ÉÜ„ÉÉ„Éó0: let x = 42;
                    2, // „Çπ„ÉÜ„ÉÉ„Éó1: let y = x;
                    3, // „Çπ„ÉÜ„ÉÉ„Éó2: y = 100;
                    5, // „Çπ„ÉÜ„ÉÉ„Éó3: let obj1 = { value: 10 };
                    6, // „Çπ„ÉÜ„ÉÉ„Éó4: let obj2 = obj1;
                    7  // „Çπ„ÉÜ„ÉÉ„Éó5: obj2.value = 20;
                ],
                "Èñ¢Êï∞Âëº„Å≥Âá∫„Åó„Å®„Çπ„Ç≥„Éº„Éó": [
                    5, // „Çπ„ÉÜ„ÉÉ„Éó0: let x = 10;
                    6, // „Çπ„ÉÜ„ÉÉ„Éó1: let y = 20;
                    7, // „Çπ„ÉÜ„ÉÉ„Éó2: let sum = add(x, y); (Èñ¢Êï∞Âëº„Å≥Âá∫„Åó)
                    0, // „Çπ„ÉÜ„ÉÉ„Éó3: function add(a, b) { („Éë„É©„É°„Éº„ÇøaË®≠ÂÆö)
                    0, // „Çπ„ÉÜ„ÉÉ„Éó4: function add(a, b) { („Éë„É©„É°„Éº„ÇøbË®≠ÂÆö)
                    1, // „Çπ„ÉÜ„ÉÉ„Éó5: let result = a + b;
                    2, // „Çπ„ÉÜ„ÉÉ„Éó6: return result;
                    7  // „Çπ„ÉÜ„ÉÉ„Éó7: let sum = add(x, y); (Êàª„ÇäÂÄ§ÂèóÂèñ)
                ],
                "„ÇØ„É≠„Éº„Ç∏„É£„Å®„É°„É¢„É™‰øùÊåÅ": [
                    6, // „Çπ„ÉÜ„ÉÉ„Éó0: Èñ¢Êï∞outerÂëº„Å≥Âá∫„ÅóÈñãÂßã
                    0, // „Çπ„ÉÜ„ÉÉ„Éó1: function outer(x) { („Éë„É©„É°„Éº„ÇøxË®≠ÂÆö)
                    1, // „Çπ„ÉÜ„ÉÉ„Éó2: return function inner(y) {
                    7, // „Çπ„ÉÜ„ÉÉ„Éó3: let closure = outer(10);
                    8, // „Çπ„ÉÜ„ÉÉ„Éó4: let result = closure(5); („ÇØ„É≠„Éº„Ç∏„É£Âëº„Å≥Âá∫„Åó)
                    1, // „Çπ„ÉÜ„ÉÉ„Éó5: function inner(y) { („Éë„É©„É°„Éº„ÇøyË®≠ÂÆö)
                    8  // „Çπ„ÉÜ„ÉÉ„Éó6: let result = closure(5); (Êàª„ÇäÂÄ§ÂèóÂèñ)
                ],
                "ÈÖçÂàó„ÅÆÂãïÁöÑ„É°„É¢„É™Ââ≤„ÇäÂΩì„Å¶": [
                    0, // „Çπ„ÉÜ„ÉÉ„Éó0: let arr = [1, 2, 3];
                    1, // „Çπ„ÉÜ„ÉÉ„Éó1: arr.push(4);
                    2, // „Çπ„ÉÜ„ÉÉ„Éó2: arr[0] = 10;
                    4, // „Çπ„ÉÜ„ÉÉ„Éó3: let arr2 = arr;
                    5  // „Çπ„ÉÜ„ÉÉ„Éó4: arr2.push(5);
                ],
                "„Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥": [
                    0, // „Çπ„ÉÜ„ÉÉ„Éó0: let obj = { data: 'important' };
                    1, // „Çπ„ÉÜ„ÉÉ„Éó1: let ref = obj;
                    3, // „Çπ„ÉÜ„ÉÉ„Éó2: obj = null;
                    4, // „Çπ„ÉÜ„ÉÉ„Éó3: ref = null;
                    5  // „Çπ„ÉÜ„ÉÉ„Éó4: „Ç¨„Éô„Éº„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
                ]
            };
            
            const mapping = scenarioMappings[scenario.title];
            if (mapping && stepIndex < mapping.length) {
                return mapping[stepIndex];
            }
            
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºö„Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
            return Math.min(stepIndex, scenario.code.length - 1);
        }
        
        // „Ç®„É≥„Éà„É™„Éè„Ç§„É©„Ç§„Éà
        function highlightEntry(entry) {
            setTimeout(() => {
                const elements = document.querySelectorAll('.memory-entry');
                elements.forEach(el => {
                    if (el.textContent.includes(entry.name)) {
                        el.classList.add('highlight');
                        setTimeout(() => el.classList.remove('highlight'), 1000);
                    }
                });
            }, 100);
        }
        
        // ÂÖ®ÂÆüË°å
        async function executeAll() {
            if (memoryManager.isRunning || !memoryManager.scenario) return;
            memoryManager.isRunning = true;
            
            while (memoryManager.currentStep < memoryManager.scenario.steps.length && memoryManager.isRunning) {
                executeStep();
                await sleep(memoryManager.executionSpeed);
            }
            
            memoryManager.isRunning = false;
        }
        
        // „É™„Çª„ÉÉ„Éà
        function reset() {
            memoryManager.isRunning = false;
            memoryManager.stack = [];
            memoryManager.heap = {};
            memoryManager.stackMemoryMap.fill(null);
            memoryManager.heapMemoryMap.fill(null);
            memoryManager.stackPointer = 0x7FFF;
            memoryManager.heapPointer = 0x1000;
            memoryManager.currentStep = 0;
            memoryManager.stackSize = 0;
            memoryManager.heapSize = 0;
            memoryManager.refCount = 0;
            
            memoryManager.renderStack();
            memoryManager.renderHeap();
            memoryManager.updateMemoryStats();
            
            // „Çπ„Çø„ÉÉ„ÇØ„É°„É¢„É™„Éû„ÉÉ„Éó„É™„Çª„ÉÉ„Éà
            const stackMemoryMap = document.getElementById('stack-memory-map');
            if (stackMemoryMap) {
                stackMemoryMap.innerHTML = '';
                for (let i = 0; i < 120; i++) {
                    const byte = document.createElement('div');
                    byte.className = 'memory-byte';
                    byte.textContent = '00';
                    stackMemoryMap.appendChild(byte);
                }
            }
            
            // „Éí„Éº„Éó„É°„É¢„É™„Éû„ÉÉ„Éó„É™„Çª„ÉÉ„Éà
            const heapMemoryMap = document.getElementById('heap-memory-map');
            if (heapMemoryMap) {
                heapMemoryMap.innerHTML = '';
                for (let i = 0; i < 120; i++) {
                    const byte = document.createElement('div');
                    byte.className = 'memory-byte';
                    byte.textContent = '00';
                    heapMemoryMap.appendChild(byte);
                }
            }
            
            // „Ç≥„Éº„ÉâË°å„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.code-line').forEach(el => {
                el.classList.remove('executing', 'executed');
            });
            
            // „Çø„Ç§„É†„É©„Ç§„É≥„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.timeline-step').forEach(el => {
                el.classList.remove('active', 'completed');
            });
        }
        
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // „Çπ„Éî„Éº„Éâ„Ç≥„É≥„Éà„É≠„Éº„É´
        document.getElementById('speed').addEventListener('input', (e) => {
            memoryManager.executionSpeed = parseInt(e.target.value);
            document.getElementById('speed-value').textContent = `${(memoryManager.executionSpeed / 1000).toFixed(1)}Áßí`;
        });
        
        // ÂàùÊúüÂåñ
        window.onload = () => {
            // „Çπ„Çø„ÉÉ„ÇØ„É°„É¢„É™„Éû„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ„ÇíÁ¢∫ÂÆü„Å´ÂÆüË°å
            const stackMemoryMap = document.getElementById('stack-memory-map');
            if (stackMemoryMap && !stackMemoryMap.children.length) {
                for (let i = 0; i < 120; i++) {
                    const byte = document.createElement('div');
                    byte.className = 'memory-byte';
                    byte.textContent = '00';
                    stackMemoryMap.appendChild(byte);
                }
            }
            
            // „Éí„Éº„Éó„É°„É¢„É™„Éû„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ„ÇíÁ¢∫ÂÆü„Å´ÂÆüË°å
            const heapMemoryMap = document.getElementById('heap-memory-map');
            if (heapMemoryMap && !heapMemoryMap.children.length) {
                for (let i = 0; i < 120; i++) {
                    const byte = document.createElement('div');
                    byte.className = 'memory-byte';
                    byte.textContent = '00';
                    heapMemoryMap.appendChild(byte);
                }
            }
            
            // „Ç∑„Éä„É™„Ç™„Çí„É≠„Éº„ÉâÔºàreset„ÅØloadScenarioÂÜÖ„ÅßÂëº„Å∞„Çå„ÇãÔºâ
            loadScenario('basic');
        };
    </script>
    <script src="/assets/js/navigation.js"></script>
</body>
</html>
