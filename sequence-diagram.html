<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ãƒ­ãƒ¼å›³ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 20px auto 0;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .main-content {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: flex-start;
        }

        .left-panel {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
        }

        .right-panel {
            flex: 0 0 600px;
            height: calc(100vh - 200px);
            position: sticky;
            top: 20px;
            min-width: 400px;
            max-width: 800px;
            align-self: flex-start;
        }

        .resize-handle {
            width: 8px;
            height: calc(100vh - 200px);
            background: #ddd;
            cursor: col-resize;
            position: sticky;
            top: 20px;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            transition: background 0.2s ease;
            align-self: flex-start;
        }

        .resize-handle:hover {
            background: #bbb;
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: #888;
            border-radius: 2px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .control-section {
            background: #f1f3f4;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dadce0;
        }

        .sample-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }

        .diagram-section {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #bbf7d0;
            height: calc(100vh - 240px);
            max-height: calc(100vh - 240px);
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .diagram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #bbf7d0;
            padding-bottom: 10px;
        }

        .diagram-header h2 {
            margin: 0;
            color: #059669;
        }

        .code-input {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            background: #fff;
            resize: vertical;
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .control-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            background: linear-gradient(145deg, #2196f3, #1976d2);
            color: white;
            border: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .generate-btn {
            background: linear-gradient(145deg, #4caf50, #45a049);
        }

        .generate-btn:hover {
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .reset-btn {
            background: linear-gradient(145deg, #ff9800, #f57c00);
        }

        .reset-btn:hover {
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .download-btn {
            background: linear-gradient(145deg, #9c27b0, #7b1fa2);
        }

        .download-btn:hover {
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }

        .sample-code-btn {
            background: linear-gradient(145deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .sample-code-btn:hover {
            background: linear-gradient(145deg, #45a049, #4caf50);
        }

        #diagramContainer {
            flex: 1;
            min-height: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #f44336;
            font-weight: bold;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success-message {
            color: #4caf50;
            font-weight: bold;
            background: #f1f8e9;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .right-panel,
            .resize-handle {
                position: relative;
                top: auto;
                height: auto;
                min-height: 400px;
            }
            
            .diagram-section {
                height: auto;
                max-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ˆ ãƒ•ãƒ­ãƒ¼å›³ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="input-section">
                    <h2>ğŸ“ ã‚³ãƒ¼ãƒ‰å…¥åŠ›</h2>
                    <textarea 
                        id="codeInput" 
                        class="code-input" 
                        placeholder="ã“ã“ã«JavaScriptã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...&#10;é–¢æ•°å‘¼ã³å‡ºã—ã‚„ã‚¯ãƒ©ã‚¹é–“ã®ç›¸äº’ä½œç”¨ã‚’ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã¨ã—ã¦å¯è¦–åŒ–ã—ã¾ã™ã€‚"
                    ></textarea>
                </div>

                <div class="control-section">
                    <h2>âš™ï¸ ç”Ÿæˆåˆ¶å¾¡</h2>
                    <div class="controls">
                        <div class="control-group">
                            <button id="generateBtn" class="generate-btn" onclick="generateDiagram()">
                                ğŸš€ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ç”Ÿæˆ
                            </button>
                            <button class="reset-btn" onclick="resetTool()">
                                ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                                <label for="pngScale" style="font-weight: bold;">PNGè§£åƒåº¦:</label>
                                <select id="pngScale" style="padding: 5px 10px; border-radius: 5px; border: 2px solid #ddd;">
                                    <option value="1">æ¨™æº– (1x)</option>
                                    <option value="2" selected>é«˜è§£åƒåº¦ (2x)</option>
                                    <option value="3">è¶…é«˜è§£åƒåº¦ (3x)</option>
                                    <option value="4">æœ€é«˜è§£åƒåº¦ (4x)</option>
                                </select>
                            </div>
                            <button id="downloadPngBtn" class="download-btn" onclick="downloadDiagram('png')" disabled>
                                ğŸ’¾ PNGä¿å­˜
                            </button>
                            <button id="downloadSvgBtn" class="download-btn" onclick="downloadDiagram('svg')" disabled>
                                ğŸ’¾ SVGä¿å­˜
                            </button>
                            <button id="downloadTextBtn" class="download-btn" onclick="downloadDiagram('text')" disabled>
                                ğŸ’¾ ã‚³ãƒ¼ãƒ‰ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>

                <div class="sample-section">
                    <h2>ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰</h2>
                    <button class="sample-code-btn" onclick="loadSampleCode('basic')">åŸºæœ¬çš„ãªé–¢æ•°å‘¼ã³å‡ºã—</button>
                    <button class="sample-code-btn" onclick="loadSampleCode('class')">ã‚¯ãƒ©ã‚¹é–“ç›¸äº’ä½œç”¨</button>
                    <button class="sample-code-btn" onclick="loadSampleCode('api')">APIå‘¼ã³å‡ºã—</button>
                    <button class="sample-code-btn" onclick="loadSampleCode('async')">éåŒæœŸå‡¦ç†</button>
                    <button class="sample-code-btn" onclick="loadSampleCode('complex')">è¤‡é›‘ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼</button>
                </div>
            </div>

            <div class="resize-handle" id="resizeHandle"></div>

            <div class="right-panel" id="rightPanel">
                <div class="diagram-section">
                    <div class="diagram-header">
                        <h2>ğŸ“Š ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³</h2>
                    </div>
                    <div id="diagramContainer">
                        <div style="text-align: center; color: #666;">
                            <h3>ğŸ¯ ä½¿ç”¨æ–¹æ³•</h3>
                            <p style="margin: 15px 0;">1. å·¦å´ã«JavaScriptã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
                            <p style="margin: 15px 0;">2. ã€Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                            <p style="margin: 15px 0;">3. ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç¢ºèªãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
                            <p style="margin-top: 20px; font-size: 0.9em;">ğŸ’¡ ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentMermaidCode = '';
        let isProcessing = false;

        // Mermaidã®åˆæœŸåŒ–
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                bottomMarginAdj: 1,
                useMaxWidth: true,
                rightAngles: false,
                showSequenceNumbers: false
            }
        });

        // ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
        const sampleCodes = {
            basic: `// åŸºæœ¬çš„ãªé–¢æ•°å‘¼ã³å‡ºã—
function main() {
    console.log("ãƒ—ãƒ­ã‚°ãƒ©ãƒ é–‹å§‹");
    processData();
    console.log("ãƒ—ãƒ­ã‚°ãƒ©ãƒ çµ‚äº†");
}

function processData() {
    const data = getData();
    const result = calculateResult(data);
    saveResult(result);
}

function getData() {
    return "ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿";
}

function calculateResult(data) {
    return data + " - å‡¦ç†æ¸ˆã¿";
}

function saveResult(result) {
    console.log("çµæœä¿å­˜:", result);
}

main();`,

            class: `// ã‚¯ãƒ©ã‚¹é–“ã®ç›¸äº’ä½œç”¨
class UserService {
    constructor() {
        this.database = new Database();
        this.emailService = new EmailService();
    }
    
    createUser(userData) {
        const user = this.database.save(userData);
        this.emailService.sendWelcomeEmail(user.email);
        return user;
    }
}

class Database {
    save(data) {
        console.log("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜:", data);
        return { id: 1, ...data };
    }
}

class EmailService {
    sendWelcomeEmail(email) {
        console.log("ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡:", email);
    }
}

const userService = new UserService();
userService.createUser({ name: "å¤ªéƒ", email: "taro@example.com" });`,

            api: `// APIå‘¼ã³å‡ºã—ã®æµã‚Œ
class ApiClient {
    constructor() {
        this.authService = new AuthService();
    }
    
    async fetchUserData(userId) {
        const token = await this.authService.getToken();
        const userData = await this.makeRequest('/users/' + userId, token);
        return this.processUserData(userData);
    }
    
    async makeRequest(endpoint, token) {
        console.log("APIå‘¼ã³å‡ºã—:", endpoint);
        return { id: 1, name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼1" };
    }
    
    processUserData(data) {
        console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‡¦ç†:", data);
        return data;
    }
}

class AuthService {
    async getToken() {
        console.log("èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—");
        return "token123";
    }
}

const client = new ApiClient();
client.fetchUserData(1);`,

            async: `// éåŒæœŸå‡¦ç†ã®ãƒ•ãƒ­ãƒ¼
class TaskManager {
    constructor() {
        this.queue = new TaskQueue();
        this.processor = new TaskProcessor();
    }
    
    async executeTask(taskData) {
        await this.queue.add(taskData);
        const task = await this.queue.get();
        const result = await this.processor.process(task);
        await this.handleResult(result);
    }
    
    async handleResult(result) {
        console.log("ã‚¿ã‚¹ã‚¯å®Œäº†:", result);
    }
}

class TaskQueue {
    async add(task) {
        console.log("ã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ :", task);
    }
    
    async get() {
        console.log("ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã‚¿ã‚¹ã‚¯å–å¾—");
        return { id: 1, type: "process" };
    }
}

class TaskProcessor {
    async process(task) {
        console.log("ã‚¿ã‚¹ã‚¯å‡¦ç†é–‹å§‹:", task);
        await this.delay(1000);
        console.log("ã‚¿ã‚¹ã‚¯å‡¦ç†å®Œäº†");
        return "å‡¦ç†çµæœ";
    }
    
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

const manager = new TaskManager();
manager.executeTask({ type: "important", data: "ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿" });`,

            complex: `// è¤‡é›‘ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼ã®ä¾‹
class OrderProcessor {
    constructor() {
        this.validator = new OrderValidator();
        this.paymentService = new PaymentService();
        this.inventoryService = new InventoryService();
        this.shippingService = new ShippingService();
        this.notificationService = new NotificationService();
    }
    
    async processOrder(orderData) {
        try {
            // 1. æ³¨æ–‡ã®æ¤œè¨¼
            await this.validator.validate(orderData);
            
            // 2. åœ¨åº«ç¢ºèª
            await this.inventoryService.checkAvailability(orderData.items);
            
            // 3. æ±ºæ¸ˆå‡¦ç†
            const paymentResult = await this.paymentService.processPayment(orderData.payment);
            
            // 4. é…é€æ‰‹ç¶šã
            const shippingInfo = await this.shippingService.arrangeShipping(orderData);
            
            // 5. é€šçŸ¥é€ä¿¡
            await this.notificationService.sendConfirmation(orderData.customerEmail, {
                payment: paymentResult,
                shipping: shippingInfo
            });
            
            return { success: true, orderId: orderData.id };
            
        } catch (error) {
            await this.handleOrderError(error, orderData);
            throw error;
        }
    }
    
    async handleOrderError(error, orderData) {
        console.log("æ³¨æ–‡ã‚¨ãƒ©ãƒ¼å‡¦ç†:", error.message);
        await this.notificationService.sendErrorNotification(orderData.customerEmail, error);
    }
}

class OrderValidator {
    async validate(orderData) {
        console.log("æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼");
        if (!orderData.items || orderData.items.length === 0) {
            throw new Error("å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
        }
    }
}

class PaymentService {
    async processPayment(paymentData) {
        console.log("æ±ºæ¸ˆå‡¦ç†é–‹å§‹");
        return { transactionId: "tx123", status: "completed" };
    }
}

class InventoryService {
    async checkAvailability(items) {
        console.log("åœ¨åº«ç¢ºèª:", items);
        return true;
    }
}

class ShippingService {
    async arrangeShipping(orderData) {
        console.log("é…é€æ‰‹ç¶šã");
        return { trackingNumber: "track123", estimatedDelivery: "2æ—¥å¾Œ" };
    }
}

class NotificationService {
    async sendConfirmation(email, orderInfo) {
        console.log("ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡:", email);
    }
    
    async sendErrorNotification(email, error) {
        console.log("ã‚¨ãƒ©ãƒ¼é€šçŸ¥é€ä¿¡:", email, error.message);
    }
}

// å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œ
const processor = new OrderProcessor();
processor.processOrder({
    id: "order123",
    customerEmail: "customer@example.com",
    items: [{ id: 1, name: "å•†å“A", quantity: 2 }],
    payment: { method: "credit_card", amount: 1000 }
});`
        };

        // ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿
        function loadSampleCode(type) {
            if (sampleCodes[type]) {
                document.getElementById('codeInput').value = sampleCodes[type];
            }
        }

        // ã‚³ãƒ¼ãƒ‰è§£æã‚¯ãƒ©ã‚¹
        class CodeAnalyzer {
            constructor(code) {
                this.code = code;
                this.actors = new Set();
                this.interactions = [];
            }

            analyze() {
                const lines = this.code.split('\n');
                let currentClass = null;
                let currentFunction = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // ã‚¯ãƒ©ã‚¹å®šç¾©ã®æ¤œå‡º
                    const classMatch = line.match(/class\s+(\w+)/);
                    if (classMatch) {
                        currentClass = classMatch[1];
                        this.actors.add(currentClass);
                        continue;
                    }
                    
                    // é–¢æ•°å®šç¾©ã®æ¤œå‡º
                    const funcMatch = line.match(/(?:function\s+(\w+)|(\w+)\s*\([^)]*\)\s*\{)/);
                    if (funcMatch) {
                        currentFunction = funcMatch[1] || funcMatch[2];
                        if (!currentClass) {
                            // æ¤œå‡ºã•ã‚ŒãŸé–¢æ•°åã‚’å€‹åˆ¥ã‚¢ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦è¿½åŠ 
                            this.actors.add(currentFunction);
                            this.actors.add('Main');
                        }
                        continue;
                    }
                    
                    // ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®æ¤œå‡º
                    this.detectMethodCalls(line, currentClass, currentFunction);
                    
                    // é–¢æ•°å‘¼ã³å‡ºã—ã®æ¤œå‡º
                    this.detectFunctionCalls(line, currentClass, currentFunction);
                    
                    // console.logã®æ¤œå‡º
                    this.detectConsoleLog(line, currentClass, currentFunction);
                }
                
                return this.generateMermaidCode();
            }

            detectMethodCalls(line, currentClass, currentFunction) {
                // this.method() ãƒ‘ã‚¿ãƒ¼ãƒ³
                const thisCallMatch = line.match(/this\.(\w+)\s*\(/g);
                if (thisCallMatch && currentClass) {
                    thisCallMatch.forEach(match => {
                        const method = match.match(/this\.(\w+)/)[1];
                        this.interactions.push({
                            from: currentClass,
                            to: currentClass,
                            message: method + "()",
                            type: 'self'
                        });
                    });
                }
                
                // object.method() ãƒ‘ã‚¿ãƒ¼ãƒ³
                const objCallMatch = line.match(/(\w+)\.(\w+)\s*\(/g);
                if (objCallMatch && currentClass) {
                    objCallMatch.forEach(match => {
                        const [, obj, method] = match.match(/(\w+)\.(\w+)/);
                        if (obj !== 'console' && obj !== 'this') {
                            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåã‹ã‚‰æ¨å®šã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¯ãƒ©ã‚¹å
                            const targetClass = this.guessClassName(obj);
                            this.actors.add(targetClass);
                            this.interactions.push({
                                from: currentClass || 'Main',
                                to: targetClass,
                                message: method + "()",
                                type: 'call'
                            });
                        }
                    });
                }
            }

            detectFunctionCalls(line, currentClass, currentFunction) {
                // ç‹¬ç«‹ã—ãŸé–¢æ•°å‘¼ã³å‡ºã— function() ãƒ‘ã‚¿ãƒ¼ãƒ³
                const funcCallMatch = line.match(/(?:^|\s|=|\(|\{)(\w+)\s*\(/g);
                if (funcCallMatch) {
                    funcCallMatch.forEach(match => {
                        let funcName = match.match(/(\w+)\s*\($/);
                        if (funcName) {
                            funcName = funcName[1];
                            // äºˆç´„èªã‚„æ—¢çŸ¥ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
                            if (!['if', 'for', 'while', 'switch', 'catch', 'return', 'new', 'console'].includes(funcName)) {
                                // æ¤œå‡ºã•ã‚ŒãŸé–¢æ•°åã‚’å€‹åˆ¥ã‚¢ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦è¿½åŠ 
                                this.actors.add(funcName);
                                
                                // æ­£ã—ã„å‘¼ã³å‡ºã—é–¢ä¿‚ã‚’è¨­å®š
                                const fromActor = currentFunction || currentClass || 'Main';
                                this.actors.add(fromActor);
                                
                                this.interactions.push({
                                    from: fromActor,
                                    to: funcName,
                                    message: funcName + "()",
                                    type: 'call'
                                });
                            }
                        }
                    });
                }
            }

            detectConsoleLog(line, currentClass, currentFunction) {
                if (line.includes('console.log')) {
                    const logMatch = line.match(/console\.log\s*\(\s*["']([^"']+)["']/);
                    if (logMatch) {
                        this.actors.add('Console');
                        this.interactions.push({
                            from: currentClass || 'Main',
                            to: 'Console',
                            message: logMatch[1],
                            type: 'log'
                        });
                    }
                }
            }

            guessClassName(objName) {
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåã‹ã‚‰ã‚¯ãƒ©ã‚¹åã‚’æ¨æ¸¬
                const commonMappings = {
                    'database': 'Database',
                    'emailService': 'EmailService',
                    'userService': 'UserService',
                    'authService': 'AuthService',
                    'paymentService': 'PaymentService',
                    'inventoryService': 'InventoryService',
                    'shippingService': 'ShippingService',
                    'notificationService': 'NotificationService',
                    'queue': 'TaskQueue',
                    'processor': 'TaskProcessor',
                    'validator': 'OrderValidator'
                };
                
                return commonMappings[objName] || this.capitalizeFirst(objName);
            }

            capitalizeFirst(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            generateMermaidCode() {
                let mermaidCode = 'sequenceDiagram\n';
                
                // ã‚¢ã‚¯ã‚¿ãƒ¼ã®è¿½åŠ 
                const actorList = Array.from(this.actors);
                actorList.forEach(actor => {
                    mermaidCode += `    participant ${actor}\n`;
                });
                
                mermaidCode += '\n';
                
                // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ 
                this.interactions.forEach(interaction => {
                    if (interaction.type === 'log') {
                        mermaidCode += `    ${interaction.from}-->>+${interaction.to}: ${interaction.message}\n`;
                        mermaidCode += `    ${interaction.to}-->>-${interaction.from}: ãƒ­ã‚°å‡ºåŠ›\n`;
                    } else if (interaction.type === 'self') {
                        mermaidCode += `    ${interaction.from}-->>+${interaction.to}: ${interaction.message}\n`;
                        mermaidCode += `    ${interaction.to}-->>-${interaction.from}: å‡¦ç†å®Œäº†\n`;
                    } else {
                        mermaidCode += `    ${interaction.from}->>+${interaction.to}: ${interaction.message}\n`;
                        mermaidCode += `    ${interaction.to}-->>-${interaction.from}: æˆ»ã‚Šå€¤\n`;
                    }
                });
                
                return mermaidCode;
            }
        }

        // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ç”Ÿæˆ
        async function generateDiagram() {
            const codeInput = document.getElementById('codeInput').value.trim();
            
            if (!codeInput) {
                showMessage('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            if (isProcessing) {
                return;
            }
            
            isProcessing = true;
            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            generateBtn.disabled = true;
            
            const diagramContainer = document.getElementById('diagramContainer');
            diagramContainer.innerHTML = '<div class="loading"></div><p>ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç”Ÿæˆä¸­...</p>';
            
            try {
                // ã‚³ãƒ¼ãƒ‰è§£æ
                const analyzer = new CodeAnalyzer(codeInput);
                const mermaidCode = analyzer.analyze();
                currentMermaidCode = mermaidCode;
                
                // Mermaidã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const diagramId = 'diagram-' + Date.now();
                const { svg } = await mermaid.render(diagramId, mermaidCode);
                
                diagramContainer.innerHTML = svg;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('downloadPngBtn').disabled = false;
                document.getElementById('downloadSvgBtn').disabled = false;
                document.getElementById('downloadTextBtn').disabled = false;
                
                showMessage('ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼', 'success');
                
            } catch (error) {
                console.error('Diagram generation error:', error);
                diagramContainer.innerHTML = `
                    <div class="error-message">
                        <h3>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                        <p>${error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ã§ã™'}</p>
                        <p>ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
                    </div>
                `;
                showMessage('ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            } finally {
                isProcessing = false;
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadDiagram(format) {
            if (!currentMermaidCode && format !== 'text') {
                showMessage('å…ˆã«ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            
            if (format === 'png') {
                downloadPNG(timestamp);
            } else if (format === 'svg') {
                downloadSVG(timestamp);
            } else if (format === 'text') {
                downloadText(timestamp);
            }
        }

        function downloadPNG(timestamp) {
            const svgElement = document.querySelector('#diagramContainer svg');
            if (!svgElement) {
                showMessage('SVGãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            // ã‚¹ã‚±ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
            const scaleSelect = document.getElementById('pngScale');
            const scale = parseInt(scaleSelect.value) || 2;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // SVGã®å…ƒã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const svgRect = svgElement.getBoundingClientRect();
            const originalWidth = svgRect.width || svgElement.clientWidth || 800;
            const originalHeight = svgRect.height || svgElement.clientHeight || 600;
            
            // é«˜è§£åƒåº¦å¯¾å¿œ: canvasã‚µã‚¤ã‚ºã‚’ã‚¹ã‚±ãƒ¼ãƒ«å€ã«è¨­å®š
            canvas.width = originalWidth * scale;
            canvas.height = originalHeight * scale;
            
            // é«˜è§£åƒåº¦æç”»ã®ãŸã‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
            ctx.scale(scale, scale);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            
            const img = new Image();
            img.onload = function() {
                // ç™½ã„èƒŒæ™¯ã‚’æç”»
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, originalWidth, originalHeight);
                
                // é«˜è§£åƒåº¦ã§SVGã‚’æç”»
                ctx.drawImage(img, 0, 0, originalWidth, originalHeight);
                
                // PNGå“è³ªè¨­å®šã§Blobç”Ÿæˆ
                canvas.toBlob(function(blob) {
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `sequence-diagram-${scale}x-${timestamp}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl);
                    showMessage(`PNG(${scale}xè§£åƒåº¦)ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`, 'success');
                }, 'image/png', 0.95); // é«˜å“è³ªPNG
                
                URL.revokeObjectURL(url);
            };
            
            img.onerror = function() {
                showMessage('PNGç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                URL.revokeObjectURL(url);
            };
            
            img.src = url;
        }

        function downloadSVG(timestamp) {
            const svgElement = document.querySelector('#diagramContainer svg');
            if (!svgElement) {
                showMessage('SVGãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `sequence-diagram-${timestamp}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('SVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚', 'success');
        }

        function downloadText(timestamp) {
            const code = currentMermaidCode || '// ã¾ãšã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„';
            const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `mermaid-code-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Mermaidã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚', 'success');
        }

        // ãƒ„ãƒ¼ãƒ«ãƒªã‚»ãƒƒãƒˆ
        function resetTool() {
            document.getElementById('codeInput').value = '';
            document.getElementById('diagramContainer').innerHTML = `
                <div style="text-align: center; color: #666;">
                    <h3>ğŸ¯ ä½¿ç”¨æ–¹æ³•</h3>
                    <p style="margin: 15px 0;">1. å·¦å´ã«JavaScriptã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
                    <p style="margin: 15px 0;">2. ã€Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                    <p style="margin: 15px 0;">3. ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç¢ºèªãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
                    <p style="margin-top: 20px; font-size: 0.9em;">ğŸ’¡ ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                </div>
            `;
            currentMermaidCode = '';
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('downloadPngBtn').disabled = true;
            document.getElementById('downloadSvgBtn').disabled = true;
            document.getElementById('downloadTextBtn').disabled = true;
            
            clearMessages();
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type) {
            clearMessages();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            const controlSection = document.querySelector('.control-section');
            controlSection.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function clearMessages() {
            const messages = document.querySelectorAll('.error-message, .success-message');
            messages.forEach(msg => msg.remove());
        }

        // ãƒ‘ãƒãƒ«ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;

        function initializeResize() {
            const resizeHandle = document.getElementById('resizeHandle');
            const rightPanel = document.getElementById('rightPanel');
            
            resizeHandle.addEventListener('mousedown', startResize);
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        function startResize(e) {
            isResizing = true;
            startX = e.clientX;
            const rightPanel = document.getElementById('rightPanel');
            startWidth = parseInt(window.getComputedStyle(rightPanel).getPropertyValue('flex-basis'), 10);
            
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        }

        function doResize(e) {
            if (!isResizing) return;
            
            const diff = startX - e.clientX;
            const newWidth = startWidth + diff;
            const rightPanel = document.getElementById('rightPanel');
            
            const minWidth = 400;
            const maxWidth = 1000;
            const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
            
            rightPanel.style.flexBasis = constrainedWidth + 'px';
        }

        function stopResize(e) {
            if (!isResizing) return;
            
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeResize();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
            loadSampleCode('basic');
        });
    </script>
    
    <!-- å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ -->
    <script src="js/navigation.js"></script>
</body>
</html>